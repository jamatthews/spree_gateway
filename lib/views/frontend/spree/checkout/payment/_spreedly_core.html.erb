<!-- Include the payment-frame library on your page -->
<script src="https://core.spreedly.com/payment-frame/payment-frame-0.3.min.js"></script>

<!-- This field will get the payment method token value after the user submits the payment frame -->
<input type="hidden" name="payment_method_token" id="payment_method_token" value="" />

<label for="first_name">First name</label>
<input type="text" id="first_name" name="first_name" /><br/>

<label for="last_name">Last name</label>
<input type="text" id="last_name" name="last_name" />

<!-- This is where the CC number and CVV fields will appear -->
<div id='frame-holder'>
<iframe id="spreedly-iframe" frameborder="0" width="100%" height="100%" scrolling="no"></iframe>
</div>

<!-- You are responsible for collecting required, but not PCI-sensitive data, such as the card exp mm/yyyy -->
<label for="month">Expiration Date</label>
<input name="month" type="text" id="month" size="3"> /
<input name="year" type="text" id="year" size="4">

<script type="text/javascript">
    var spreedlyPaymentFrame = new Spreedly.PaymentFrame("<%= payment_method.preferred_publishable_key %>");
    document.getElementById('frame-holder').style.visibility="hidden";
    // Rest of PaymentFrame configuration will go in between, here
    spreedlyPaymentFrame.bind(document.getElementById('spreedly-iframe'));

    function submitPaymentForm() {

        // These are the fields whose values we want to transfer *from* the
        // master form *to* the payment frame form.
        var paymentMethodFields = ['first_name', 'last_name', 'month', 'year']
        for(var i = 0; i < paymentMethodFields.length; i++) {
            var field = paymentMethodFields[i];
            spreedlyPaymentFrame.setParam(field, document.getElementById(field).value)
        }
        spreedlyPaymentFrame.submit();
    }

    spreedlyPaymentFrame.on('paymentMethod', function(token, pmData) {
        var masterForm = $('#checkout_form_payment');

        masterForm.append("<input type='hidden' class='spreedlyToken' name='payment_source[" + <%= payment_method.id %> + "][gateway_payment_profile_id]' value='" + token + "'/>");
        masterForm.append("<input type='hidden' class='spreedlyToken' name='payment_source[" + <%= payment_method.id %> + "][last_digits]' value='" + pmData.last_four_digits + "'/>");
        masterForm.append("<input type='hidden' class='spreedlyToken' name='payment_source[" + <%= payment_method.id %> + "][month]' value='" + pmData.month + "'/>");
        masterForm.append("<input type='hidden' class='spreedlyToken' name='payment_source[" + <%= payment_method.id %> + "][year]' value='" + pmData.year + "'/>");


        masterForm.removeAttr('onsubmit');
        masterForm.submit();
    });

    spreedlyPaymentFrame.on('errors', function(errors) {
        for(var i = 0; i < errors.length; i++) {
            var error = errors[i];
            if(error["attribute"]) {
                spreedlyPaymentFrame.setStyle('input#spf-' + error["attribute"], "border: 1px solid red;");
            } else {
                console.log(error["key"] + ": " + error["message"]);
            }
        }
    });

    var masterForm = document.getElementById('checkout_form_payment')

    masterForm.onsubmit = function(){
        submitPaymentForm();
        return false;
    };

    spreedlyPaymentFrame.on('ready', function() {
        document.getElementById("frame-holder").style.visibility = 'visible';
    });
</script>

